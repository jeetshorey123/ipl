{% extends "base.html" %}

{% block title %}Cricket Analytics Hub - Dashboard{% endblock %}

{% block content %}
<!-- Clean Sporty Hero Section -->
<div class="hero-section text-center py-5 mb-5">
    <div class="container">
        <h1 class="display-2 fw-bold text-white mb-4">
            Cricket Analytics Hub
        </h1>
        <p class="lead mb-4 text-muted-light">
            Professional cricket statistics, player analysis, and match predictions
        </p>
        <div class="trophy-3d mx-auto mb-4"></div>
    </div>
</div>

<!-- Stats Section -->
<div class="container mt-5">
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="text-center mb-5 text-dark">Platform Overview</h2>
        </div>
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="stat-card">
                <h3 id="statMatches">-</h3>
                <p>Matches Loaded</p>
                <small class="text-muted" id="statProgress" style="display:block"></small>
                <div class="progress mt-2" style="height: 6px;">
                    <div id="statProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="stat-card">
                <h3 id="statPlayers">-</h3>
                <p>Players Tracked</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="stat-card">
                <h3>95%</h3>
                <p>Prediction Accuracy</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="stat-card">
                <h3>24/7</h3>
                <p>Live Updates</p>
            </div>
        </div>
    </div>
    
    <!-- Clean Search Section -->
    <div class="row justify-content-center mb-5">
        <div class="col-md-10">
            <div class="search-container">
                <div class="search-bar position-relative">
                    <input type="text" class="form-control" id="globalSearch" 
                           placeholder="Search players, teams, venues..." autocomplete="off">
                    <button class="btn btn-primary" id="globalSearchBtn" type="button">
                        <i class="fas fa-search"></i>
                        <span class="ms-2">Search</span>
                    </button>
                    <div id="globalSearchList" class="list-group position-absolute w-100" style="z-index: 1000; top: 48px; display: none; max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clean Quick Stats -->
<div class="container">
    <div class="row mb-5">
        <div class="col-md-3 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-users text-primary mb-3" style="font-size: 2rem;"></i>
                    <h3 class="text-primary" id="totalPlayers">-</h3>
                    <p class="text-muted mb-0">Total Players</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-trophy text-warning mb-3" style="font-size: 2rem;"></i>
                    <h3 class="text-primary" id="totalMatches">-</h3>
                    <p class="text-muted mb-0">Matches Loaded</p>
                    <small class="text-muted" id="loadProgress"></small>
                    <div class="progress mt-2" style="height: 6px;">
                        <div id="loadProgressBar" class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-chart-line text-success mb-3" style="font-size: 2rem;"></i>
                    <h3 class="text-primary" id="avgScore">-</h3>
                    <p class="text-muted mb-0">Average Score</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-star text-info mb-3" style="font-size: 2rem;"></i>
                    <h3 class="text-primary" id="topScore">-</h3>
                    <p class="text-muted mb-0">Highest Score</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Feature Cards -->
    <div class="row mb-5">
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-user-circle text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="card-title text-center">Player Analytics</h5>
                    <p class="card-text text-muted">
                        Comprehensive player statistics including batting averages, strike rates, 
                        bowling figures, and detailed performance analysis.
                    </p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Batting & Bowling Stats</li>
                        <li><i class="fas fa-check text-success me-2"></i>Dismissal Analysis</li>
                        <li><i class="fas fa-check text-success me-2"></i>Performance Filters</li>
                        <li><i class="fas fa-check text-success me-2"></i>Career Milestones</li>
                    </ul>
                    <div class="text-center">
                        <a href="{{ url_for('players') }}" class="btn btn-primary">Explore Players</a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-users text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="card-title text-center">Team Comparison</h5>
                    <p class="card-text text-muted">
                        Analyze team performance, head-to-head records, win percentages, 
                        and strategic insights across different formats.
                    </p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Win/Loss Records</li>
                        <li><i class="fas fa-check text-success me-2"></i>Head-to-Head Analysis</li>
                        <li><i class="fas fa-check text-success me-2"></i>Format Performance</li>
                        <li><i class="fas fa-check text-success me-2"></i>Recent Form</li>
                    </ul>
                    <div class="text-center">
                        <a href="{{ url_for('teams') }}" class="btn btn-secondary">Compare Teams</a>
                    </div>
                </div>
            </div>
        </div>
        
        
    </div>
    <div class="row">
        <div class="col-12">
            <div id="globalSearchResult" class="mt-3" style="display:none"></div>
        </div>
    </div>
</div>

<!-- Quick Analysis Section -->
<div class="container">
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Quick Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="quickPlayerSelect" class="form-label">Select Player</label>
                            <select class="form-select" id="quickPlayerSelect">
                                <option value="">Choose a player...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="quickFormatSelect" class="form-label">Format</label>
                            <select class="form-select" id="quickFormatSelect">
                                <option value="">All Formats</option>
                                <option value="Test">Test</option>
                                <option value="ODI">ODI</option>
                                <option value="T20">T20</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="quickAnalyzeBtn">
                        <i class="fas fa-chart-line me-2"></i>Quick Analyze
                    </button>
                    
                    <div id="quickAnalysisResult" class="mt-4" style="display: none;">
                        <!-- Quick analysis results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trophy me-2"></i>
                        Featured Content
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="fw-bold text-primary">Top Performers</h6>
                        <p class="small text-muted mb-2">Leading run scorers this season</p>
                        <div class="d-flex align-items-center mb-2">
                            <div class="cricket-ball me-2" style="width: 20px; height: 20px;"></div>
                            <span class="small">View batting leaders</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="fw-bold text-success">Recent Matches</h6>
                        <p class="small text-muted mb-2">Latest match results and highlights</p>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-calendar-check text-success me-2"></i>
                            <span class="small">View recent games</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Load quick stats on page load
document.addEventListener('DOMContentLoaded', function() {
    loadQuickStats();
    loadPlayerOptions();
    startHealthPolling();
    initUnifiedSearch();
});

function loadQuickStats() {
    // Use health endpoint for authoritative counts
    fetch('/api/data/health')
        .then(response => response.json())
        .then(h => {
            if (typeof h.players_count === 'number') {
                document.getElementById('totalPlayers').textContent = h.players_count.toLocaleString();
                const sp = document.getElementById('statPlayers');
                if (sp) sp.textContent = h.players_count.toLocaleString();
            }
            if (typeof h.matches_loaded === 'number') {
                document.getElementById('totalMatches').textContent = h.matches_loaded.toLocaleString();
            }
        })
        .catch(error => console.error('Error loading quick stats:', error));
        
    // Matches will be updated by health polling
}

function loadPlayerOptions() {
    fetch('/api/data/players')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('quickPlayerSelect');
            if (data.players) {
                data.players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player;
                    option.textContent = player;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading players:', error));
}

function startHealthPolling() {
    const matchesEl = document.getElementById('totalMatches');
    const statMatchesEl = document.getElementById('statMatches');
    const statPlayersEl = document.getElementById('statPlayers');
    const progressEl = document.getElementById('loadProgress');
    const statProgressEl = document.getElementById('statProgress');
    const loadBar = document.getElementById('loadProgressBar');
    const statBar = document.getElementById('statProgressBar');
    let timer = null;
    const update = () => {
        fetch('/api/data/health')
            .then(r => r.json())
            .then(h => {
                const loaded = h.matches_loaded ?? 0;
                const total = h.total_files ?? 0;
                const loading = !!h.loading;
                matchesEl.textContent = loaded.toLocaleString();
                statMatchesEl.textContent = loaded.toLocaleString();
                if (typeof h.players_count === 'number' && statPlayersEl) {
                    statPlayersEl.textContent = h.players_count.toLocaleString();
                }
                const filesLoaded = h.files_loaded ?? loaded;
                let pct = 0;
                if (total && total > 0) {
                    pct = Math.floor((filesLoaded / total) * 100);
                } else if (loading) {
                    pct = 0;
                } else if (!loading && loaded > 0) {
                    pct = 100;
                }
                const msg = total ? `${filesLoaded}/${total} files • ${pct}%` : (loading ? 'Loading…' : (loaded > 0 ? '100%' : ''));
                progressEl.textContent = msg;
                statProgressEl.textContent = msg;
                if (loadBar) {
                    loadBar.style.width = `${pct}%`;
                    loadBar.setAttribute('aria-valuenow', String(pct));
                }
                if (statBar) {
                    statBar.style.width = `${pct}%`;
                    statBar.setAttribute('aria-valuenow', String(pct));
                }
                if (!loading && timer) {
                    clearInterval(timer);
                    timer = null;
                }
            })
            .catch(() => {});
    };
    update();
    timer = setInterval(update, 2000);
}

// Quick analyze functionality
document.getElementById('quickAnalyzeBtn').addEventListener('click', function() {
    const player = document.getElementById('quickPlayerSelect').value;
    const format = document.getElementById('quickFormatSelect').value;
    
    if (!player) {
        alert('Please select a player for analysis');
        return;
    }
    
    const resultDiv = document.getElementById('quickAnalysisResult');
    resultDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Analyzing...</div>';
    resultDiv.style.display = 'block';
    
    const params = new URLSearchParams();
    if (format) params.append('format', format);
    
    fetch(`/api/player-stats/${encodeURIComponent(player)}?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                resultDiv.innerHTML = '<div class="alert alert-warning">No data found for selected player.</div>';
                return;
            }
            
            const batting = data.batting || {};
            const bowling = data.bowling || {};
            
            resultDiv.innerHTML = `
                <div class="card border-primary">
                    <div class="card-body">
                        <h6 class="card-title text-primary">${player} - Quick Stats</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Matches:</small> <strong>${batting.matches || 0}</strong><br>
                                <small class="text-muted">Runs:</small> <strong>${batting.runs || 0}</strong><br>
                                <small class="text-muted">Average:</small> <strong>${batting.average || '0.00'}</strong>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Strike Rate:</small> <strong>${batting.strike_rate || '0.00'}</strong><br>
                                <small class="text-muted">High Score:</small> <strong>${batting.high_score || 0}</strong><br>
                                <small class="text-muted">Centuries:</small> <strong>${batting.hundreds || 0}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            resultDiv.innerHTML = '<div class="alert alert-danger">Error loading player analysis.</div>';
        });
});

// Global search functionality
document.getElementById('globalSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        performGlobalSearch();
    }
});
    // Unified search (combined players, teams, venues)
    function initUnifiedSearch() {
        const input = document.getElementById('globalSearch');
        const list = document.getElementById('globalSearchList');
        const btn = document.getElementById('globalSearchBtn');
        let options = [];
        fetch('/api/data/unified-options')
            .then(r => r.json())
            .then(d => { options = (d.options || []); })
            .catch(() => { options = []; });
        function renderSuggestions(q) {
            const ql = q.toLowerCase();
            const items = options.filter(o => o.name.toLowerCase().includes(ql)).slice(0, 20);
            if (!q || items.length === 0) {
                list.style.display = 'none';
                list.innerHTML = '';
                return;
            }
            list.innerHTML = items.map(o => `<button type="button" class="list-group-item list-group-item-action" data-type="${o.type}" data-name="${o.name}"><span class="badge bg-secondary me-2 text-uppercase">${o.type}</span>${o.name}</button>`).join('');
            list.style.display = 'block';
        }
        input.addEventListener('input', () => renderSuggestions(input.value.trim()));
        input.addEventListener('focus', () => renderSuggestions(input.value.trim()));
        document.addEventListener('click', (e) => {
            if (!list.contains(e.target) && e.target !== input) {
                list.style.display = 'none';
            }
        });
        list.addEventListener('click', (e) => {
            const btn = e.target.closest('button.list-group-item');
            if (!btn) return;
            const name = btn.getAttribute('data-name');
            const type = btn.getAttribute('data-type');
            input.value = name;
            list.style.display = 'none';
            performUnifiedSearch(name, type);
        });
        btn.addEventListener('click', () => performUnifiedSearch(input.value.trim(), ''));
    }


function performGlobalSearch() {
    const query = document.getElementById('globalSearch').value.trim();
            performUnifiedSearch(query, '');
        window.location.href = `/search?q=${encodeURIComponent(query)}`;
    }

    function performUnifiedSearch(q, type) {
        const resDiv = document.getElementById('globalSearchResult');
        resDiv.style.display = 'block';
        resDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>';
        const params = new URLSearchParams();
        params.append('q', q);
        if (type) params.append('type', type);
        fetch(`/api/search?${params}`)
            .then(r => r.json())
            .then(d => {
                if (d.error) {
                    resDiv.innerHTML = `<div class="alert alert-warning">${d.error}</div>`;
                    return;
                }
                if (d.suggestions) {
                    const items = d.suggestions.map(s => `<li class="list-group-item"><span class="badge bg-secondary me-2 text-uppercase">${s.type}</span>${s.name}</li>`).join('');
                    resDiv.innerHTML = `<div class="card"><div class="card-body"><h6 class="mb-3">No exact match. Suggestions:</h6><ul class="list-group">${items}</ul></div></div>`;
                    return;
                }
                const kind = d.type;
                const name = d.name;
                const data = d.data || {};
                // Render a concise summary per kind
                if (kind === 'player') {
                    const bat = data.batting || {};
                    const bowl = data.bowling || {};
                    resDiv.innerHTML = `
                    <div class="card border-primary"><div class="card-body">
                        <h5 class="text-primary mb-3"><i class="fas fa-user me-2"></i>${name} — Overview</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div><small class="text-muted">Matches:</small> <strong>${bat.matches || 0}</strong></div>
                                <div><small class="text-muted">Runs:</small> <strong>${bat.runs || 0}</strong></div>
                                <div><small class="text-muted">Average:</small> <strong>${bat.average || '0.00'}</strong></div>
                            </div>
                            <div class="col-md-6">
                                <div><small class="text-muted">Strike Rate:</small> <strong>${bat.strike_rate || '0.00'}</strong></div>
                                <div><small class="text-muted">100s:</small> <strong>${bat.hundreds || 0}</strong></div>
                                <div><small class="text-muted">Wickets:</small> <strong>${bowl.wickets || 0}</strong></div>
                            </div>
                        </div>
                    </div></div>`;
                } else if (kind === 'team') {
                    const general = data.general || {};
                    resDiv.innerHTML = `
                    <div class="card border-secondary"><div class="card-body">
                        <h5 class="text-secondary mb-3"><i class="fas fa-users me-2"></i>${name} — Overview</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div><small class="text-muted">Matches:</small> <strong>${general.total_matches || 0}</strong></div>
                                <div><small class="text-muted">Wins:</small> <strong>${general.wins || 0}</strong></div>
                            </div>
                            <div class="col-md-4">
                                <div><small class="text-muted">Losses:</small> <strong>${general.losses || 0}</strong></div>
                                <div><small class="text-muted">Win%:</small> <strong>${general.win_percentage || 0}</strong></div>
                            </div>
                            <div class="col-md-4">
                                <div><small class="text-muted">Toss Win%:</small> <strong>${general.toss_win_percentage || 0}</strong></div>
                            </div>
                        </div>
                    </div></div>`;
                } else if (kind === 'venue') {
                    const general = data.general || {};
                    resDiv.innerHTML = `
                    <div class="card border-info"><div class="card-body">
                        <h5 class="text-info mb-3"><i class="fas fa-map-marker-alt me-2"></i>${name} — Overview</h5>
                        <div class="row">
                            <div class="col-md-4"><div><small class="text-muted">Matches:</small> <strong>${general.total_matches || 0}</strong></div></div>
                            <div class="col-md-4"><div><small class="text-muted">Teams Played:</small> <strong>${general.teams_played || 0}</strong></div></div>
                            <div class="col-md-4"><div><small class="text-muted">Formats:</small> <strong>${Object.keys(general.formats||{}).join(', ')}</strong></div></div>
                        </div>
                    </div></div>`;
                } else {
                    resDiv.innerHTML = `<div class="alert alert-secondary">No result.</div>`;
                }
            })
            .catch(() => {
                resDiv.innerHTML = '<div class="alert alert-danger">Error performing search</div>';
            });
    }
</script>
{% endblock %}